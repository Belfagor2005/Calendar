# .github/workflows/update-all-translations.yml
name: Update All Plugin Translations

on:
  push:
    branches: [ main, master ]
    paths:
      - '**/*.py'
      - '**/*.xml'
      - '**/locale/**'
  schedule:
    - cron: '0 0 * * 0'  # Ogni domenica
  workflow_dispatch:

jobs:
  update-all:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup translation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gettext \
          python3-lxml \
          python3-bs4
        
    - name: Verify script exists
      run: |
        echo "üìÅ Repository structure:"
        find . -maxdepth 3 -type f -name "*.py" | grep -E "(update|translation)" | head -20
        echo ""
        echo "üîç Looking for update_all_plugins.py:"
        if [ -f "update_all_plugins.py" ]; then
          echo "‚úÖ Found: update_all_plugins.py"
          ls -la update_all_plugins.py
        else
          echo "‚ùå ERROR: update_all_plugins.py not found in root!"
          echo "Current directory: $(pwd)"
          echo "Files in root:"
          ls -la
        fi
        
    - name: Run universal translation updater
      run: |
        echo "üöÄ Starting translation update for ALL plugins..."
        python3 update_all_plugins.py
        
    - name: Show translation report
      run: |
        if [ -f "translation_update_report.json" ]; then
          echo "üìä TRANSLATION REPORT:"
          echo "======================"
          python3 << 'EOF'
import json, os

if os.path.exists("translation_update_report.json"):
    with open("translation_update_report.json", "r") as f:
        data = json.load(f)
    
    print(f"Total plugins: {data['total_plugins']}")
    print(f"Successful: {data['successful']}")
    print(f"Failed: {data['failed']}")
    print(f"Timestamp: {data['timestamp']}")
    print()
    print("Details:")
    for detail in data['details']:
        status = '‚úÖ' if detail['success'] else '‚ùå'
        print(f"{status} {detail['plugin_name']}:")
        print(f"    New strings: {detail['new_strings']}")
        print(f"    Updated PO: {detail['updated_po']}")
        print(f"    Compiled MO: {detail['compiled_mo']}")
        if detail['errors']:
            print(f"    Errors: {detail['errors']}")
EOF
        else
          echo "‚ö†Ô∏è No translation report found"
        fi
        
    - name: Commit changes if any
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
        # Check for any changed translation files
        changed_files=$(git status --porcelain | grep -E '\.(po|mo|pot|json)$' | grep -v '^??' || true)
        
        if [ -n "$changed_files" ]; then
          echo "üìù Found changes to commit:"
          echo "$changed_files"
          git add --all
          git commit -m "üåç Auto-update all plugin translations [$(date +'%Y-%m-%d %H:%M:%S')]"
          git push
        else
          echo "‚úÖ No translation files changed"
        fi
        
    - name: Upload report artifact
      uses: actions/upload-artifact@v4
      with:
        name: translation-reports
        path: |
          translation_update_report.json
          **/locale/**/*.pot
          **/locale/**/*.po
          **/locale/**/*.mo
        retention-days: 7
        
    - name: Create workflow summary
      if: always()
      run: |
        echo "### üìã Translation Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "translation_update_report.json" ]; then
          python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
import json, os, sys

if os.path.exists("translation_update_report.json"):
    with open("translation_update_report.json", "r") as f:
        data = json.load(f)
    
    successful = data['successful']
    total = data['total_plugins']
    failed = data['failed']
    
    if successful == total:
        status = "‚úÖ All plugins updated successfully"
    elif successful > 0:
        status = "‚ö†Ô∏è Partial success"
    else:
        status = "‚ùå All plugins failed"
    
    print(f"**Status:** {status}")
    print('')
    print(f"**Processed plugins:** {total}")
    print(f"**Successful:** {successful}")
    print(f"**Failed:** {failed}")
    print('')
    print("**Plugin details:**")
    for detail in data['details']:
        status = '‚úÖ' if detail['success'] else '‚ùå'
        print(f"- {status} **{detail['plugin_name']}**")
        print(f"  - New strings: {detail['new_strings']}")
        print(f"  - Updated PO files: {detail['updated_po']}")
        print(f"  - Compiled MO files: {detail['compiled_mo']}")
EOF
        else
          echo "**Status:** ‚ùå No report generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The translation update script did not generate a report." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Automatically generated by GitHub Actions*" >> $GITHUB_STEP_SUMMARY
  