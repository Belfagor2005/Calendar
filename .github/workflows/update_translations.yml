# .github/workflows/update-all-translations.yml
name: Update All Plugin Translations

on:
  push:
    branches: [ main, master ]
    paths:
      - '**/*.py'
      - '**/*.xml'
      - '**/locale/**'
  schedule:
    - cron: '0 0 * * 0'  # Ogni domenica
  workflow_dispatch:

jobs:
  update-all:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup translation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gettext \
          python3-lxml \
          python3-bs4
        
    - name: Run universal translation updater
      run: |
        python3 update_all_plugins.py
        
    - name: Show translation report
      run: |
        if [ -f "translation_update_report.json" ]; then
          echo "ðŸ“Š TRANSLATION REPORT:"
          echo "======================"
          cat translation_update_report.json | python3 -c "
import json, sys
data = json.load(sys.stdin)
print(f'Total plugins: {data[\"total_plugins\"]}')
print(f'Successful: {data[\"successful\"]}')
print(f'Failed: {data[\"failed\"]}')
print(f'Timestamp: {data[\"timestamp\"]}')
print()
print('Details:')
for detail in data['details']:
    status = 'âœ…' if detail['success'] else 'âŒ'
    print(f'{status} {detail[\"plugin_name\"]}:')
    print(f'    New strings: {detail[\"new_strings\"]}')
    print(f'    Updated PO: {detail[\"updated_po\"]}')
    print(f'    Compiled MO: {detail[\"compiled_mo\"]}')
    if detail['errors']:
        print(f'    Errors: {detail[\"errors\"]}')
          "
        else
          echo "No translation report found"
        fi
        
    - name: Commit changes if any
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
        # Check for any changed translation files
        if git status --porcelain | grep -E '\.(po|mo|pot|json)$' | grep -v '^??'; then
          echo "ðŸ“ Found changes to commit"
          git add --all
          git commit -m "ðŸŒ Auto-update all plugin translations [$(date +'%Y-%m-%d %H:%M:%S')]"
          git push
        else
          echo "âœ… No translation files changed"
        fi
        
    - name: Upload report artifact (updated to v4)
      uses: actions/upload-artifact@v4
      with:
        name: translation-reports
        path: |
          translation_update_report.json
          **/locale/**/*.pot
          **/locale/**/*.po
          **/locale/**/*.mo
        retention-days: 7
        
    - name: Create workflow summary
      if: always()
      run: |
        echo "### ðŸ“‹ Translation Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "translation_update_report.json" ]; then
          cat translation_update_report.json | python3 -c "
import json, sys
data = json.load(sys.stdin)

successful = data['successful']
total = data['total_plugins']
failed = data['failed']

print(f'**Status:** {"âœ… Success" if successful > 0 else "âš ï¸ Partial" if successful > 0 and failed > 0 else "âŒ Failed"}')
print('')
print(f'**Processed plugins:** {total}')
print(f'**Successful:** {successful}')
print(f'**Failed:** {failed}')
print('')
print('**Plugin details:**')
for detail in data['details']:
    status = 'âœ…' if detail['success'] else 'âŒ'
    print(f'- {status} **{detail[\"plugin_name\"]}**')
    print(f'  - New strings: {detail[\"new_strings\"]}')
    print(f'  - Updated PO files: {detail[\"updated_po\"]}')
    print(f'  - Compiled MO files: {detail[\"compiled_mo\"]}')
          " >> $GITHUB_STEP_SUMMARY
        else
          echo "**Status:** âŒ No report generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The translation update script did not generate a report." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Automatically generated by GitHub Actions*" >> $GITHUB_STEP_SUMMARY
